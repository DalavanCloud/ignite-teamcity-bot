<html>
<head>
    <title>Ignite Teamcity - current failures</title>
    <link rel="icon" href="https://pbs.twimg.com/profile_images/568493154500747264/xTBxO73F.png">
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.16/css/jquery.dataTables.min.css">
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

    <script src="https://cdn.datatables.net/1.10.16/js/jquery.dataTables.min.js"></script>

    <style>
        body {
	font-family: Arial;
	font-size: 12px;
	font-style: normal;
	font-variant: normal;
	font-weight: 500;
}
    </style>
</head>
<body>
<script>
$(document).ready(function() {
    $( document ).tooltip();
    loadData();
    setInterval(loadData, 60000)
});

function findGetParameter(parameterName) {
    var result = null,
        tmp = [];
    location.search
        .substr(1)
        .split("&")
        .forEach(function (item) {
          tmp = item.split("=");
          if (tmp[0] === parameterName) result = decodeURIComponent(tmp[1]);
        });
    return result;
}

function loadData() {
    var curFailuresUrl = "rest/current/failures";
    var branch = findGetParameter("branch");
    if(branch!=null) {
        curFailuresUrl += "?branch=" + branch;
    }
    $("#loadStatus").html("<img src='https://www.wallies.com/filebin/images/loading_apple.gif' width=20px height=20px> Please wait");
    $.ajax({
        url: curFailuresUrl,
        success: function(result) {
            $("#loadStatus").html("");
            if(result.updateRequired) {
                setTimeout(loadData, 1000)
            }
            showData(result);
        },
        error: function(jqXHR, exception) {
            if (jqXHR.status === 0) {
                $("#loadStatus").html('Not connect.\n Verify Network.');
            } else if (jqXHR.status == 404) {
                $("#loadStatus").html('Requested page not found. [404]');
            } else if (jqXHR.status == 500) {
                $("#loadStatus").html('Internal Server Error [500].');
            } else if (exception === 'parsererror') {
                $("#loadStatus").html('Requested JSON parse failed.');
            } else if (exception === 'timeout') {
                $("#loadStatus").html('Time out error.');
            } else if (exception === 'abort') {
                $("#loadStatus").html('Ajax request aborted.');
            } else {
                $("#loadStatus").html('Uncaught Error.\n' + jqXHR.responseText);
            }
        }

    }, );
}

function showData(result) {
    $("#divFailures").html("");
    var arrayLength = result.servers.length;
    for (var i = 0; i < arrayLength; i++) {
        var server = result.servers[i];
        $("#divFailures").append(showServerData(server));
        //Do something
    }
}

//see ChainCurrentStatus
function showServerData(server) {
    var res = "";
    var altTxt = "duration: " + server.durationPrintable;

    res += "<b><a href='" + server.webToHist + "'>" + server.serverName + "</a> ";
    res += "[";
    res += " <a href='" + server.webToBuild + "' title='"+altTxt+"'>"
    res += "tests " + server.failedTests + " suites " + server.failedToFinish + "";
    res += " </a>"
    res += "]";
    res += "</b><br><br>";

    var arrayLength = server.suites.length;
    for (var i = 0; i < arrayLength; i++) {
        var suite = server.suites[i];
        res += showSuiteData(suite);
    }

    return res;
}

function showSuiteData(suite) {
    var res = "";
    var altTxt = "duration: " + suite.durationPrintable;
    res += "<a href='" + suite.webToHist + "'>" + suite.name + "</a> " +
        "[ "+ "<a href='" + suite.webToBuild + "' title='"+altTxt+"'> " + "tests " + suite.failedTests + " " + suite.result + "</a> ]" +
        " " + suite.contactPerson + "" +
        " <br>";

    for (var i = 0; i < suite.testFailures.length; i++) {
        var testFail = suite.testFailures[i];
        res += showTestFailData(testFail);
    }

    if(typeof suite.webUrlThreadDump !== 'undefined' && suite.webUrlThreadDump!=null) {
        res += "&nbsp; <a href='" + suite.webUrlThreadDump + "'>";
        res += "<img src='https://cdn2.iconfinder.com/data/icons/metro-uinvert-dock/256/Services.png' width=12px height=12px> ";
        res += "Thread Dump</a>"
        res += " <br>";
    }

    res += " <br>";
    return res;
}

//todo common script
function componentToHex(c) {
    var hex = c.toString(16);
    return hex.length == 1 ? "0" + hex : hex;
}

function rgbToHex(r, g, b) {
    return "#" + componentToHex(r) + componentToHex(g) + componentToHex(b);
}

function showTestFailData(testFail) {
    var res = "";
    res += "&nbsp; ";

    var haveIssue = typeof testFail.webIssueUrl !== 'undefined' && testFail.webIssueUrl!=null
                    && typeof testFail.webIssueText !== 'undefined' && testFail.webIssueText!=null;

    var redSaturation = 255;
    var greenSaturation = 0;
    var blueSaturation = 0;
    var colorCorrect = 0;
    if(testFail.failureRate !== 'undefined' && testFail.failureRate!= null) {
        colorCorrect = parseFloat(testFail.failureRate);
    }
    if(colorCorrect < 50) {
        redSaturation = 255;
        greenSaturation += colorCorrect * 5;
    } else {
        greenSaturation += 255
        redSaturation -= (colorCorrect-50) * 5;
    }
    var color = rgbToHex(redSaturation, greenSaturation, blueSaturation);
    res += " <span style='background-color: " + color + "; width:7px; height:7px; display: inline-block; border-width: 1px; border-color: black; border-style: solid; '></span> ";


    if(haveIssue) {
        res += "<a href='"+testFail.webIssueUrl+"'>";
        res += testFail.webIssueText;
        res += "</a>";
        res += ": ";
    };

    res += testFail.name;

    var haveWeb = typeof testFail.webUrl !== 'undefined' && testFail.webUrl!=null;
    var histContent = "";
    if (testFail.failures != null && testFail.runs != null) {
        histContent += " <span title='" + testFail.failures + " fails / " + testFail.runs + " runs in all tracked branches in helper DB'>";
        if(testFail.failureRate !== 'undefined' && testFail.failureRate!= null )
            histContent += "(fail rate " + testFail.failureRate + "%)";
        else
            histContent += "(fails: " + testFail.failures + "/" + testFail.runs + ")";
        histContent += "</span>";
    } else if(haveWeb) {
        histContent += " (test history)";
    }
    if (haveWeb)
        res += "<a href='"+testFail.webUrl+"'>";
    res += histContent;
    if (haveWeb)
        res += "</a>";

    res += " <br>";
    return res;
}
</script>

<div id="divFailures"></div>


<div id="loadStatus"></div>

</body>
</html>